---
# Workflow for triggering a release.
name: Release
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch: # Dispatch runs build and validate, then push to the appropriate storage location.
    inputs:
      type:
        description: Build Type
        default: nightly
        required: true
      version:
        description: Version Tag
        default: nightly
        required: true
concurrency: # This keeps multiple instances of the job from running concurrently for the same ref and event type.
  group: release-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true
jobs:
  update-changelogs:
    name: Update changelog
    runs-on: ubuntu-latest
    outputs:
      ref: ${{ steps.target.outputs.ref }}
      version: ${{ steps.target.outputs.version }}
      type: ${{ steps.target.outputs.type }}
      run: ${{ steps.target.outputs.run }}
    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Prepare base ref
        id: target
        run: >-
          .github/scripts/prepare-release-base.sh \
              ${{ github.repository }} \
              ${{ github.event_name }} \
              ${{ github.event.inputs.type }} \
              ${{ github.event.inputs.version }} \
              ${{ secrets.NETDATA_RELEASE_TEST }}
      - name: Set up git-cliff
        id: setup-git-cliff
        if: steps.target.outputs.run == 'true'
        uses: kenji-miyake/setup-git-cliff@v2
      - name: Generate Release Changelog
        id: release-changelog
        if: steps.target.outputs.run == 'true'
        run: packaging/generate-changelog.sh
      - name: Commit Changes
        id: commit
        if: steps.target.outputs.run == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "netdatabot"
          git config user.email "bot@netdata.cloud"
          git add packaging/version CHANGELOG.md
          git commit -m "[ci skip] ${{ steps.target.outputs.message }}"
          if [ "${{ steps.target.outputs.type }}" != "nightly" ]; then
            git tag -a "${{ github.event.inputs.version }}" -m "${{ steps.target.outputs.message }}"
          fi
          if [ -n "${{ steps.target.outputs.new-branch }}" ]; then
            git branch "${{ steps.target.outputs.new-branch }}"
          fi
          git push --tags origin "${{ steps.target.outputs.branch }}"
          if [ -n "${{ steps.target.outputs.new-branch }}" ]; then
            git push origin "${{ steps.target.outputs.new-branch }}"
          fi

  trigger-artifacts:
    name: Trigger artifact builds
    runs-on: ubuntu-latest
    needs: update-changelogs
    if: needs.update-changelogs.outputs.run == 'true'
    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.update-changelogs.outputs.ref }}
      - name: Trigger build
        id: trigger
        uses: benc-uk/workflow-dispatch@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repo: ${{ github.repository }}
          workflow: build.yml
          ref: ${{ needs.update-changelogs.outputs.ref }}
          inputs: '{"version": "${{ needs.update-changelogs.outputs.version }}", "type": "${{ needs.update-changelogs.outputs.type }}"}'

  # Docker and package builds disabled for fork (only static builds needed)
  # trigger-docker:
  # trigger-packages:
